# í¬íŒ…ë§¤ë‰´ì–¼

# 1. ì‚¬ìš© ê¸°ëŠ¥ ë° ë²„ì „

- AWS
    - ubuntu - 20.04
    - nginx - 1.18.0
    - docker - 24.0.7
    - Openjdk - 17.0.8.1

- BackEnd
    - Java - 17.0.8.1
    - springboot - 3.1.4
    - springbatch - 5
    - quartz

- FrontEnd_Web
    - React.js - 18.2.0
    - Typescript - 4.9.5
    - axios - 1.6.0

- FrontEnd_App
    - Kotlin - 1.8.10
    - Compose(bom:23.03 / 1.4~)
    - Room - 2.6.0

- DB
    - PostgreSQL(postgis) 12-3.0
    - Redis
    - S3

- IDE
    - VS code
    - intelliJ IDEA

# 2. AWS í™˜ê²½ ì„¤ì •

## SSL ì¸ì¦ì„œ ì„¤ì •

- Https í†µì‹ ì„ ìœ„í•œ ssl ì¸ì¦ì„œ
    
    - Certbot ì„¤ì¹˜
    
    ```bash
    sudo apt-get update
    sudo apt-get install certbot
    ```

    - ì¸ì¦ì„œ ë°œê¸‰ ë° ì„¤ì¹˜

    ```bash
    sudo certbot certonly --standalone -d k9b109.p.ssafy.io
    ```
    
    - ì¸ì¦ì„œ ìœ„ì¹˜ : /etc/letsencrypt/live/<ë„ë©”ì¸ì£¼ì†Œ>/

    - ì¸ì¦ì„œ í™•ì¸
    ```bash
    sudo certbot certificates
    ```
    

## Nignx ì„¤ì¹˜ ë° ì„¤ì •

- Nginx ì„¤ì¹˜

    ```bash
    # nginx ì„¤ì¹˜
    sudo apt update
    sudo apt install nginx -y
    ```

- Nginx ì„œë¹„ìŠ¤ ê´€ë¦¬

    ```bash
    sudo systemctl start nginx
    sudo systemctl enable nginx
    ```

- DNS ì£¼ì†Œ í™•ì¸
    ```bash
    cat /etc/resolv.conf
    ```

- Nginx íŒŒì¼ ë° ê²½ë¡œ : /etc/nginx/sites-enabled/default
    ```bash

    server{
        listen 80; #80í¬íŠ¸ë¡œ ë°›ì„ ë•Œ
        server_name k9b109.p.ssafy.io; 
        return 301 https://$host$request_uri;
    }
    server {
        listen 443 ssl default_server;
        server_name k9b109.p.ssafy.io;
        include /etc/nginx/conf.d/backend-url.inc;
        include /etc/nginx/conf.d/frontend-url.inc;
        # ssl ì¸ì¦ì„œ ì ìš©í•˜ê¸°
        ssl_certificate /etc/letsencrypt/live/k9b109.p.ssafy.io/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/k9b109.p.ssafy.io/privkey.pem;

        client_max_body_size 75M;
        resolver 127.0.0.53;

        location / {
            # /ë¡œ ë“¤ì–´ì˜¤ëŠ” ê²½ìš°
            proxy_pass $frontend_url;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cross-Origin-Embedder-Policy' '*';
            add_header 'Cross-Origin-Opener-Policy' 'same-origin';
        }

        location /api {
            # ì¼ë°˜ API í˜¸ì¶œì˜ ê²½ìš°
            proxy_pass $backend_url;
            charset utf-8;
            fastcgi_send_timeout 300;
            fastcgi_read_timeout 300;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme; 
        }   
    
    }
    ```

- /etc/nginx/conf.d/backend-url.inc
    
    ```bash
    set $backend_url http://localhost:8082;
    ```
    
- /etc/nginx/conf.d/frontend-url.inc
    
    ```bash
    set $frontend_url http://localhost:3001;
    ```

- Nginx ë°©í™”ë²½ ì„¤ì •

    ```bash
    sudo ufw allow 80
    sudo ufw allow 443
    sudo ufw enable
    ```


## Docker & Docker-Compose

- Ubuntu
- apt ì—…ë°ì´íŠ¸ ë° íŒ¨í‚¤ì§€ ì„¤ì¹˜
    
    ```bash
    sudo apt update
    sudo apt install apt-transport-https ca-certificates curl software-properties-common
    ```
    
    
- GPG í‚¤ ë° ì €ì¥ì†Œ ì¶”ê°€
    ```bash
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh ./get-docker.sh
    ```
    
    
    ```bash
    echo \
      "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
      $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    ```
    
- docker ì„¤ì¹˜ í™•ì¸
    
    ```bash
    docker --version
    ```

## Jenkins

- docker-compose.yml íŒŒì¼

    ```bash
    # docker-compose.yml íŒŒì¼ ë‚´ìš©
    version: '3'

    services:
        jenkins:
            image: jenkins/jenkins:jdk17
            container_name: jenkins
            volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - /jenkins:/var/jenkins_home
                - /etc/nginx/conf.d:/var/nginx
            ports:
                - "9090:8080"
            environment:
                - TZ=Asia/Seoul
            user: root
    ```

- ì»¨í…Œì´ë„ˆ ì‹¤í–‰
    ```bash
    sudo docker compose up -d
    ```

- Jenkins ì»¨í…Œì´ë„ˆ ì ‘ì† í›„ ë„ì»¤ ì„¤ì¹˜
    ```bash
    # Jenkins ì»¨í…Œì´ë„ˆ ì ‘ì†
    sudo docker exec -it jenkins /bin/bash
    ```

    ```bash
    # ë„ì»¤ ì„¤ì¹˜
    sudo docker exec -it jenkins /bin/bash
    apt-get update
    apt-get install ca-certificates curl gnupg lsb-release
    mkdir -p /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    echo \
    "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
    $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

    apt-get update
    apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin docker-compose
    ```


## DB ì„¤ì •

### PostgreSQL DB

- Docker PostgreSQL(postgis) DB ì´ë¯¸ì§€ ë‹¤ìš´
    
    ```bash
    sudo docker pull postgis/postgis:12-3.0
    ```
    
- Dockerì— PostgreSQL(postgis) DB ì»¨í…Œì´ë„ˆ ë§Œë“¤ê³  ì‹¤í–‰í•˜ê¸°
    ```bash
    docker run -dp 5432:5432 --name postgres_sql -e TZ=Asia/Seoul -e POSTGRES_DB=bangrang -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=@ssafy_b109_bangrang -v /var/lib/postgres_main:/var/lib/postgres/data postgis/postgis:12-3.0
    ```

- Docker dpage/pgadmin4(DB ì ‘ì†) ì´ë¯¸ì§€ ë‹¤ìš´ 
    ```bash
    sudo docker pull dpage/pgadmin4
    ```

- Docker dpage/pgadmin4(DB ì ‘ì†) ì»¨í…Œì´ë„ˆ ë§Œë“¤ê³  ì‹¤í–‰í•˜ê¸°
    ```bash
    docker run -dp 5555:80 --name pgadmin -e TZ=Asia/Seoul -e PGADMIN_DEFAULT_EMAIL=example@pgadmin.com -e PGADMIN_DEFAULT_PASSWORD=pgadmin -v /var/lib/pgadmin_main:/var/lib/pgadmin --link postgres_sql dpage/pgadmin4
    ```
- Docker - PostgreSQL(postgis) ì»¨í…Œì´ë„ˆ ì ‘ì†í•˜ê¸°
    ```bash
    docker exec -it postgres_sql /bin/bash
    psql -U postgres
    ```

- PostgreSQL ì‚¬ìš©ì ì¶”ê°€í•˜ê¸°
    ```bash
    create user bangrang with encrypted password 'password';
    ```

- ì‚¬ìš©ì ê¶Œí•œ ë¶€ì—¬í•˜ê¸°
    ```bash
    grant all privileges on database bangrang to bangrang;
    ```

## Redis
- Redis ì´ë¯¸ì§€ ë°›ê¸°
    ```bash
    sudo docker pull redis:latest
    ```

- ë„ì»¤ ë„¤íŠ¸ì›Œí¬ ìƒì„±[ë””í´íŠ¸ê°’]
    ```bash
    sudo docker network create redis-network
    ```

- myredisë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë¡œì»¬-docker ê°„ 6379 í¬íŠ¸ ê°œë°©
    ```bash
    sudo docker run --name myredis -p 6379:6379 -v /redis_temp:/data -d redis:latest redis-server --appendonly yes  --requirepass "b109ssafy!"
    ```

- ì»¨í…Œì´ë„ˆ ì§„ì…
    ```bash
    docker run -it --link myredis:redis --rm redis redis-cli -h myredis -p 6379
    ``` 

- Redis Default ê³„ì • ë¡œê·¸ì¸
    ```bash
    myredis:6379> auth b109ssafy!
    ```

- Redis ê³„ì • ìƒì„±
    ```bash
    acl setuser bangrang-b109 on >b109ssafy! allkeys allcommands
    ```

- ê¶Œí•œ ì¶”ê°€
    ```bash
    # slaveof no one : í˜„ì¬ ìŠ¬ë ˆì´ë¸Œ(ë³µì œ)ì¸ ìì‹ ì„ ë§ˆìŠ¤í„°ë¡œ ë§Œë“­ë‹ˆë‹¤.
    myredis:6379> slaveof no one
    ```
    
## í”„ë¡œì íŠ¸ êµ¬ì„±

```
root
|
|-- FrontEnd_Web
|-- |-- src
|-- |-- public
|-- |-- package.json
|-- |-- package-lock.json
|-- |-- tsconfig.json
|-- |-- Dockerfile
|-- |-- nginx
|-- |-- |-- default.conf
|
|-- FrontEnd_App/bangrang
|-- |-- gradle
|-- |-- build.gradle.kts
|-- |-- gradle.properties
|-- |-- gradlew
|-- |-- settings.gradle.kts
|-- |-- app
|-- |-- |-- build.gradle.kts
|-- |-- |-- proguard-rules.pro
|-- |-- |-- src
|-- |-- |-- |-- main
|-- |-- |-- |-- |-- AndroidManifest.xml
|
|-- BackEnd
|-- |-- gradle
|-- |-- gradlew
|-- |-- gradlew.bat
|-- |-- build.gradle
|-- |-- settings.gradle
|-- |-- Dockerfile
|-- |-- src
|-- |-- |-- main
|-- |-- |-- |-- resources
|-- |-- |-- |-- |-- application.yml
|-- |-- |-- |-- |-- bangrang-a8e4f-firebase-adminsdk-f6i7f-ec2129f2d5.json
```


## Frontend_Web
- í”„ë¡œì íŠ¸ì˜ root directoryë¥¼ /path ë¼ê³  ì„¤ëª…

- Nginx ì„¤ì • íŒŒì¼
    
    ```bash
    sudo vi /path/Frontend_Web/nginx/default.conf
    ```
    
    - docker containerì—ì„œ ì‹¤í–‰ë˜ëŠ” nginx ì„¤ì • íŒŒì¼
    
    ```bash
    server {
    listen 3001;

    location / {

        root /usr/share/nginx/html;

        index index.html index.htm;

        try_files $uri  $uri/ /index.html;
        }
    }
    ```
    
- React Dockerfile
    
    - Docker image ë¹Œë“œë¥¼ ìœ„í•œ Dockerfile ìƒì„±
    - React í”„ë¡œì íŠ¸ root Directoryì— ìƒì„±
    
    ```docker
    FROM node:alpine as builder

    WORKDIR /usr/src/app
    COPY ./package.json /usr/src/app/package.json
    RUN npm install --force

    COPY . /usr/src/app
    RUN npm run build

    FROM nginx
    COPY ./nginx/default.conf /etc/nginx/conf.d/default.conf

    COPY --from=builder /usr/src/app/build /usr/share/nginx/html
    ```
    
## React ì„¤ì • íŒŒì¼

- React ì‹¤í–‰ì„ ìœ„í•œ ì„¤ì • íŒŒì¼
    
    ```bash
    sudo vi /path/FrontEnd_Web/.env
    ```
    
    - React í”„ë¡œì íŠ¸ ì„¤ì •íŒŒì¼ ìƒì„±
    
    ```bash
        REACT_APP_API = https://k9b109.p.ssafy.io/api

        REACT_APP_NAVER_MAP_CLIENT_ID = {client_id}

    ```
    
## Backend

- Springboot Dockerfile
    
    ```bash
    sudo vi /path/BackEnd/Dockerfile
    ```
    
- Docker image ë¹Œë“œë¥¼ ìœ„í•œ Dockerfile ìƒì„±
- Springboot í”„ë¡œì íŠ¸ root Directoryì— ìƒì„±
    
    ```docker
    FROM openjdk:17-jdk as builder
    COPY build/libs/*.jar app.jar
    ENTRYPOINT ["java", "-Djava.security.egd=file:/dev/./urandom","-Duser.timezone=Asia/Seoul", "-jar", "/app.jar"]

    ```
    
- application.yml íŒŒì¼ ìƒì„±
    ```bash
    sudo vi /path/BackEnd/src/main/resources/application.yml
    ```
    
    ```java
            cloud:
        aws:
            s3:
            bucket: bangrang-bucket
            region:
            static: ap-northeast-2
            auto: false
            stack:
            auto: false
            credentials:
            access-key: {access-key}
            secret-key: {secret-key}
        naver:
            client_id: {client_id}
            client_secret: {client_secret}

        spring:
            h2:
                console:
                enabled: false

        # jpa ì„¤ì •
        jpa:
            hibernate:
            ddl-auto: create
            dialect: org.hibernate.spatial.dialect.postgis.PostgisDialect
            properties:
            hibernate:
                show_sql: true
                format_sql: true
            use_sql_comments: true
            database: postgresql

        # mysql ì„¤ì •
        datasource:
            driver-class-name: org.postgresql.Driver
            url: jdbc:postgresql://k9b109.p.ssafy.io:5432/bangrang?charSet=utf-8&prepareThreshold=1
            username: bangrang
            password: {password}
                
        # redis ì„¤ì •
        data:
            redis:
            host: k9b109.p.ssafy.io
            port: 6379
            password: {password}

        # íŒŒì¼ ì—…ë¡œë“œ ìš©ëŸ‰ì œí•œ
        servlet:
            multipart:
            max-file-size: 20MB
            max-request-size: 20MB

        # Spring Batch ì„¤ì •
        batch:
            job:
                enabled: true
            jdbc:
                # neverë¡œ ë°”ê¿”ì£¼ê¸°
                initialize-schema: always
                schema: classpath:org/springframework/batch/core/schema-postgresql.sql

        quartz:
            jdbc:
                initialize-schema: always

        # jwt ì„¤ì •
        jwt:
        # ì‹œí¬ë¦¿í‚¤
            secretKey: {secretKey}
        access:
            expiration: 3600000
            header: Authorization
        refresh:
            expiration: 1209600000
            header: Authorization-Refresh

        logging.level:
            org.springframework.data.redis: ERROR

        server:
            port: 8081

        fcm:
            certification: bangrang-a8e4f-firebase-adminsdk-f6i7f-ec2129f2d5.json
    ```
    
## Blue-Green íŒŒì´í”„ë¼ì¸
- FrontEnd
    ```bash
        pipeline {
        agent any
        
        environment {
            BLUE_CONTAINER = "frontend-blue"
            GREEN_CONTAINER = "frontend-green"
            BLUE_IMAGE_NAME = "bangrang-frontend-blue"
                    GREEN_IMAGE_NAME = "bangrang-frontend-green"
            TARGET_CONTAINER = ""
        }
        
            stages {
            stage('Git Clone') {
                steps {
                    sh 'echo "Cloning Repository"'
                    git branch: 'FrontEnd_Web',
                    url: 'https://lab.ssafy.com/s09-final/S09P31B109.git',
                    credentialsId: "jenkins_token" // GitLab Credential ID
                }
                post {
                    success {
                        sh 'echo "Successfully Cloned Repository"'
                    }
                    failure {
                        sh 'echo "Failed to Clone Repository"'
                    }
                }
            }
            stage('Dockerizing'){
                steps{
                                    script {
                                        def blueRunning = sh(script: "docker ps --format '{{.Names}}' | grep -w ${BLUE_CONTAINER}", returnStatus: true) == 0

                        if (blueRunning) {
                            TARGET_CONTAINER = GREEN_CONTAINER
                                sh 'echo "GREEN Image Build Start"'
                                sh """
                                    cd FrontEnd_Web
                                    touch .env
                                    echo 'REACT_APP_API=https://k9b109.p.ssafy.io/api' >> .env
                                    echo 'REACT_APP_NAVER_MAP_CLIENT_ID = {client_id}' >> .env
                                    docker build -t ${GREEN_IMAGE_NAME} .
                                """
                        } else {
                            TARGET_CONTAINER = BLUE_CONTAINER
                                sh 'echo "Blue Image Build Start"'
                                sh """
                                    cd FrontEnd_Web
                                                        touch .env
                                    echo 'REACT_APP_API=https://k9b109.p.ssafy.io/api' >> .env
                                                        docker build -t ${BLUE_IMAGE_NAME} .
                                """
                        }
                                    }
                }
                post {
                    success {
                        sh 'echo "Build Docker Image Success"'
                    }
                    failure {
                        sh 'echo "Build Docker Image Fail"'
                    }
                }
            }
            stage('Deploy') {
                steps {
                    script {
                        if (TARGET_CONTAINER == GREEN_CONTAINER) {
                            sh """
                                docker run --name ${GREEN_CONTAINER} -d -p 3002:3001 ${GREEN_IMAGE_NAME} 
                            """
                        } else {
                            sh """
                                docker run --name ${BLUE_CONTAINER} -d -p 3001:3001 ${BLUE_IMAGE_NAME}
                            """
                        }
                        def myNumbers = [1, 2, 3, 4, 5]
                        for (retry_count in myNumbers) {
                            if (sh(script: "docker ps -q -f name=${TARGET_CONTAINER}", returnStatus: true) == 0) {
                                echo "âœ… Health Checking ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!"
                                break
                            }

                            if (retry_count == 5) {
                                echo "âŒ Health checking ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
                                error("Health checking ì‹¤íŒ¨")
                            }

                            echo "ğŸ¥ 10ì´ˆí›„ì— ë‹¤ì‹œ Health Checking ì´ ì‹œë„ë  ì˜ˆì •ì…ë‹ˆë‹¤."
                            sleep 10
                        }

                        if (TARGET_CONTAINER == GREEN_CONTAINER) {
                            sh "echo 'set \$frontend_url http://k9b109.p.ssafy.io:3002;' > /var/nginx/frontend-url.inc"
                            echo "Switch the reverse proxy direction of nginx to ${TARGET_CONTAINER} : 3002ğŸ”„"
                            sshagent(credentials:['ec_key']) {
                                sh "ssh -o StrictHostKeyChecking=no ubuntu@k9b109.p.ssafy.io sudo systemctl reload nginx"
                            }
                            
                            try {
                                // ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ë©´ ì‚­ì œí•©ë‹ˆë‹¤.
                                sh "docker stop ${BLUE_CONTAINER}"
                                sh "docker rm -f ${BLUE_CONTAINER}"
                                                            sh "docker image rm ${BLUE_IMAGE_NAME}"
                            } catch (Exception e) {
                                // ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì—ëŸ¬ë¥¼ ë¬´ì‹œí•©ë‹ˆë‹¤.
                                echo "Docker container ${BLUE_CONTAINER} does not exist. Skipping deletion."
                            }
                        } else {
                            sh "echo 'set \$frontend_url http://k9b109.p.ssafy.io:3001;' > /var/nginx/frontend-url.inc"
                            echo "Switch the reverse proxy direction of nginx to ${TARGET_CONTAINER} : 3001 ğŸ”„"
                            sshagent(credentials:['ec_key']) {
                                sh "ssh -o StrictHostKeyChecking=no ubuntu@k9b109.p.ssafy.io sudo systemctl reload nginx"
                            }
                            try {
                                // ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ë©´ ì‚­ì œí•©ë‹ˆë‹¤.
                                sh "docker stop ${GREEN_CONTAINER}"
                                sh "docker rm -f ${GREEN_CONTAINER}"
                                                            sh "docker image rm ${GREEN_IMAGE_NAME}"
                            } catch (Exception e) {
                                // ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì—ëŸ¬ë¥¼ ë¬´ì‹œí•©ë‹ˆë‹¤.
                                echo "Docker container ${GREEN_CONTAINER} does not exist. Skipping deletion."
                            }
                        }
                    }
                }
                post {
                    success {
                        echo 'deploy success'
                    }
                    failure {
                        echo 'deploy failed'
                    }
                }
            }


            }
    }
    ```

- Backend
    ```bash
        pipeline {
        agent any
        
        environment {
                    BLUE_CONTAINER = "backend-blue"
            GREEN_CONTAINER = "backend-green"
            BLUE_IMAGE_NAME = "bangrang-backend-blue"
                    GREEN_IMAGE_NAME = "bangrang-backend-green"
            TARGET_CONTAINER = ""
        }
        
            stages {
            stage('Git Clone') {
                steps {
                    sh 'echo "Cloning Repository"'
                    git branch: 'BackEnd',
                    url: 'https://lab.ssafy.com/s09-final/S09P31B109.git',
                    credentialsId: "jenkins_token" // GitLab Credential ID
                }
                post {
                    success {
                        sh 'echo "Successfully Cloned Repository"'
                    }
                    failure {
                        sh 'echo "Failed to Clone Repository"'
                    }
                }
            }
            stage('Build') {
                steps {
                    withCredentials([file(credentialsId: 'spring_env', variable: 'springFile')]) {
                        script {
                            sh 'cp $springFile ./BackEnd/src/main/resources/application.yml'
                        }
                    }
                    withCredentials([file(credentialsId: 'firebase_env', variable: 'firebaseFile')]) {
                        script {
                            sh 'cp $firebaseFile ./BackEnd/src/main/resources/bangrang-a8e4f-firebase-adminsdk-f6i7f-ec2129f2d5.json'
                        }
                    }
                    sh '''
                        pwd
                        cd BackEnd
                        chmod +x ./gradlew
                        ./gradlew clean build --exclude-task test
                    '''
                }
                post {
                    // build ì„±ê³µì‹œ
                    success {
                        echo 'gradle build success'
                    }
                    // build ì‹¤íŒ¨ì‹œ
                    failure {
                        echo 'gradle build failed'
                    }
                }
            }
            stage('Dockerizing'){
                steps{
                    script {
                        def blueRunning = sh(script: "docker ps --format '{{.Names}}' | grep -w ${BLUE_CONTAINER}", returnStatus: true) == 0
                        
                        if (blueRunning) {
                            TARGET_CONTAINER = GREEN_CONTAINER
                                sh 'echo "GREEN Image Build Start"'
                                sh """
                                    cd BackEnd
                                    docker build -t ${GREEN_IMAGE_NAME} .
                                """
                        } else {
                            TARGET_CONTAINER = BLUE_CONTAINER
                                sh 'echo "Blue Image Build Start"'
                                sh """
                                    cd BackEnd
                                    docker build -t ${BLUE_IMAGE_NAME} .
                                """
                        }
                                    }
                }
                post {
                    success {
                        sh 'echo "Build Docker Image Success"'
                    }
                    failure {
                        sh 'echo "Build Docker Image Fail"'
                    }
                }
            }
            stage('Deploy') {
                steps {
                    script {
                        if (TARGET_CONTAINER == GREEN_CONTAINER) {
                            sh """
                                docker run --name ${GREEN_CONTAINER} -d -p 8082:8081 --network=redis-network ${GREEN_IMAGE_NAME} 
                            """
                        } else {
                            sh """
                                docker run --name ${BLUE_CONTAINER} -d -p 8081:8081 --network=redis-network ${BLUE_IMAGE_NAME}
                            """
                        }
                        def myNumbers = [1, 2, 3, 4, 5]
                        for (retry_count in myNumbers) {
                            if (sh(script: "docker ps -q -f name=${TARGET_CONTAINER}", returnStatus: true) == 0) {
                                echo "âœ… Health Checking ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!"
                                break
                            }

                            if (retry_count == 5) {
                                echo "âŒ Health checking ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
                                error("Health checking ì‹¤íŒ¨")
                            }

                            echo "ğŸ¥ 10ì´ˆí›„ì— ë‹¤ì‹œ Health Checking ì´ ì‹œë„ë  ì˜ˆì •ì…ë‹ˆë‹¤."
                            sleep 10
                        }

                        if (TARGET_CONTAINER == GREEN_CONTAINER) {
                            sh "echo 'set \$backend_url http://k9b109.p.ssafy.io:8082;' > /var/nginx/backend-url.inc"
                            echo "Switch the reverse proxy direction of nginx to ${TARGET_CONTAINER} : 8082ğŸ”„"
                            sshagent(credentials:['ec_key']) {
                                sh "ssh -o StrictHostKeyChecking=no ubuntu@k9b109.p.ssafy.io sudo systemctl reload nginx"
                            }
                            
                            try {
                                // ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ë©´ ì‚­ì œí•©ë‹ˆë‹¤.
                                sh "docker stop ${BLUE_CONTAINER}"
                                sh "docker rm -f ${BLUE_CONTAINER}"
                                                            sh "docker image rm ${BLUE_IMAGE_NAME}"
                            } catch (Exception e) {
                                // ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì—ëŸ¬ë¥¼ ë¬´ì‹œí•©ë‹ˆë‹¤.
                                echo "Docker container ${BLUE_CONTAINER} does not exist. Skipping deletion."
                            }
                        } else {
                            sh "echo 'set \$backend_url http://k9b109.p.ssafy.io:8081;' > /var/nginx/backend-url.inc"
                            echo "Switch the reverse proxy direction of nginx to ${TARGET_CONTAINER} : 8081 ğŸ”„"
                            sshagent(credentials:['ec_key']) {
                                sh "ssh -o StrictHostKeyChecking=no ubuntu@k9b109.p.ssafy.io sudo systemctl reload nginx"
                            }
                            try {
                                // ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ë©´ ì‚­ì œí•©ë‹ˆë‹¤.
                                sh "docker stop ${GREEN_CONTAINER}"
                                sh "docker rm -f ${GREEN_CONTAINER}"
                                                            sh "docker image rm ${GREEN_IMAGE_NAME}"
                            } catch (Exception e) {
                                // ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì—ëŸ¬ë¥¼ ë¬´ì‹œí•©ë‹ˆë‹¤.
                                echo "Docker container ${GREEN_CONTAINER} does not exist. Skipping deletion."
                            }
                        }
                    }
                }
                post {
                    success {
                        echo 'deploy success'
                    }
                    failure {
                        echo 'deploy failed'
                    }
                }
            }


            }
    }
    ```
